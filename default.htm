<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>TypeScript HTML App</title>
    <link rel="stylesheet" href="app.css" type="text/css" />

    <!-- submodules -->
    <script src="submodules/promise/Promise.js"></script>
    <script src="submodules/streams/streams.js"></script>

    <script src="mjpegdecoder.js"></script>

    <script>
        var exported;
        var currentVideoTime = 0;
        var stopToken = false;
        function decode() {
            MJPEGReader.read(loader.files[0])
                .then(function (mjpeg) {
                    exported = mjpeg;
                    image.style.display = "block";
                    console.log("Decode completed.");
                });
        }
        function show(time) {
            currentVideoTime = time;
            timer.value = time;
            presenter.src = URL.createObjectURL(exported.getFrameByTime(time), { oneTimeOnly: true });
        }
        function auto() {
            var startedTime = Date.now() / 1000;
            var startedVideoTime = currentVideoTime;
            var asyncOperation = function () {
                if (stopToken) {
                    stopToken = false;
                    return;
                }

                var targetTime = startedVideoTime + Date.now() / 1000 - startedTime;
                if (targetTime < exported.duration) {
                    show(targetTime);
                    window.setTimeout(asyncOperation, 10);
                }
                else
                    show(exported.duration);
            };
            asyncOperation();
        }
    </script>
</head>
<body>
    <h1>TypeScript HTML App</h1>

    <div id="content">
        <label for="loader">Load File: </label><input name="loader" id="loader" type="file" />
        <input type="button" value="Push to decode" onclick="decode()" />
    </div>
    <div id="image" style="display: none;">
        <label for="timer">Time: </label><input name="timer" id="timer" type="number" value="0" />
        <input type="button" value="Push to show image" onclick="show(parseFloat(timer.value))" /><br />
        <input type="button" value="Play" onclick="auto()" /><input type="button" value="Stop" onclick="stopToken = true;" /><br />
        <img id="presenter" />
    </div>
</body>
</html>